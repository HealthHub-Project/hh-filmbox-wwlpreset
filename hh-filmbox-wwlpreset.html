<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../vaadin-icons/vaadin-icons.html">
<script src="../ag-grid-enterprise/dist/ag-grid-enterprise.js"></script>
<link rel="import" href="../ag-grid-polymer/ag-grid-polymer.html">

<script src="licenseKey.js"></script>
<dom-module id="hh-filmbox-wwlpreset">
    <template>
        <link rel="stylesheet" href="../bower_components/ag-grid/dist/styles/ag-grid.css">
        <link rel="stylesheet" href="../bower_components/ag-grid/dist/styles/ag-theme-balham-dark.css">
        <style>
            :host {
                display: block;
                /*height: 100%;*/
                /*width: 100%;*/
                /*height: 300px;*/
                /*width: 300px;*/
            }

            ag-grid-polymer {
                width: 100%;
                height: 100%;
                color: #aaaaaa !important;
                font-size: 12px !important;
                font-weight: normal !important;
                background-color: #2d333f !important;
                font-family: "NotoSansCJKLight" !important;
            }

            .ag-header {
                background-color: #2d333f !important;
                color: #cccccc !important;
                border-bottom: 3px solid #0087cb !important;
                font-weight: bold !important;
                font-size: 12px !important;
            }

            .ag-row {
                border-bottom: 1px solid #414a59 !important;
            }

            .ag-row-even {
                background-color: rgba(76, 86, 103, 0.2) !important;
            }

            .ag-row-odd {
                background-color: #2d333f !important;
            }

            .ag-row-selected {
                background-color: #596072 !important;
                color: #fff !important;
            }

            .ag-cell-focus {
                border: 1px solid darkgrey !important;
            }

            /*paper-input,paper-dropdown-menu{*/
            paper-input{
                --paper-input-container-focus-color: #0087cb;
                --paper-input-container-label-color: #aaaaaa;
                --paper-input-container-input-text-align: center;
                --paper-input-container-input-color: #aaaaaa;

                width: 100px;
                color: #aaaaaa;
                background: #2d333f;
                text-align: center;
            }

            paper-dropdown-menu, paper-listbox {
                --paper-input-container-focus-color: #0087cb;
                --paper-input-container-label: {
                    color: #aaaaaa;
                };
                --paper-input-container-input: {
                    text-align: center;
                    color: #aaaaaa;
                };

                width: 110px;
                color: #aaaaaa;
                background: #2d333f;
            }

            paper-item{
                --paper-item-min-height: 30px;
                --paper-item-focused-color: #0087cb;
                color: #aaaaaa;
                font-size: 16px;
            }

            .container {
                height: 100%;
                width: 100%;
                padding: 0px;
                margin: 0px;
            }

            .class-WWLDialog {
                background: #2d333f;
                width: 450px;
                /*height: 430px;*/
            }

            .class-WWL-list {
                height: 180px;
                width: 96%;
                margin: 10px 10px 15px 10px;
            }

            .menuItems-title {
                background-color: #252934;
                height: 50px;
                width: 100%;
                color: #fff;
                border-bottom: 1px solid #4c5667;
            }

            #xBtnWWL {
                width: 50px;
                height: 50px;
                padding: 15px;
                float: right;
                color: #aaaaaa;
                border: 0;
            }

            .text-font {
                width: 55px;
                padding: 0 7px;
                font-size: 10pt;
                color: #aaaaaa;
                margin: 5px 5px 0 5px;
            }

            .class-WWL-context {
                width: 100%;
                height: 30%;
            }

            .class-list-content {
                height: 100%;
                width: 100%;
            }

            .wrap {
                display: flex;
                flex-direction: row;
                padding-top: 3px;
                padding-bottom: 3px;
                height: 40px;
            }

            .classWWLBtn {
                text-align: center;
                margin: 15px 0px 10px 0px;
                height: 40px;
                flex: 1;
            }

            #okBtnWWL{
                background: #0087cb;
            }

            #closeBtnWWL, #clearBtnWWL{
                background: #4c5667;
            }

            .btn {
                width: 122px;
                height: 30px;
                border: 0;
                font-size: 10pt;
                color: #ffffff;
                cursor: pointer;
                border-radius: 2px;
            }

            .ag-theme-balham-dark .ag-row-drag1 {
                background-image: url("resource/unsorted.png");
                background-color: transparent;
                background-position: center;
                background-repeat: no-repeat;
                background-size: 16px 16px;
                height: 16px;
                opacity: 0.87;
                width: 16px;
                background-position-x: left;
                background-position-y: 4px;
                float: left;
                height: 100%;
                width: 28px;
                background-position-y: center;
                color: #ffffff;
            }

            /*.test {*/
            /*height: 100px;*/
            /*width: 100px;*/
            /*background: gold;*/
            /*}*/
        </style>
        <div class="container">
            <!--<button class="test" id="testBtn">open</button>-->
            <paper-dialog id="WWLDialog" class="class-WWLDialog" horizontal-align="left" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
                <div class="container">
                    <div class="menuItems-title">
                        <p style="margin: 0; padding: 15px; float: left;">WWL Preset</p>
                        <paper-icon-button id="xBtnWWL" on-click="" icon="vaadin:close-big"></paper-icon-button>
                    </div>
                    <div class="class-WWL-context">
                        <div class="wrap">
                            <input id="windowDialogIdx" style="display: none">
                            <div class="text-font">Window Level</div>
                            <paper-input type="number" id="windowDialogLevel" class="class-windowDialog-input"
                                         style="width: 100px;" no-label-float></paper-input>
                            <div class="text-font" style="margin-left: 50px">Window Width</div>
                            <paper-input type="number" id="windowDialogWidth" class="class-windowDialog-input"
                                         style="width: 100px; color: #aaaaaa;" no-label-float></paper-input>
                        </div>
                        <div class="wrap">
                            <div class="text-font">Title</div>
                            <paper-input type="String" id="windowDialogTitle" class="class-windowDialog-input"
                                         maxlength="7" style="width: 100px;" no-label-float></paper-input>
                            <div class="text-font" style="margin-left: 50px">Modality</div>
                            <paper-dropdown-menu label="Modality" id="modality" noLabelFloat>
                                <paper-listbox id="modalityList" slot="dropdown-content" style="padding: 0px;">
                                </paper-listbox>
                            </paper-dropdown-menu>
                        </div>
                        <div class="wrap">
                            <div class="text-font">Shortcut</div>
                            <paper-input type="number" id="key" class="class-windowDialog-input"
                                         style="width: 100px;" no-label-float></paper-input>
                        </div>
                    </div>
                    <div class="class-WWL-list">
                        <div class="class-list-content">
                            <ag-grid-polymer
                                    class="ag-theme-balham-dark"
                                    rowData="{{rowData}}"
                                    columnDefs="{{columnDefs}}"
                                    gridOptions="{{gridOptions}}"
                            ></ag-grid-polymer>
                        </div>
                    </div>
                    <div class="classWWLBtn">
                        <button id="okBtnWWL" class="btn" style="width: 80px">Save</button>
                        &nbsp;
                        <button id="clearBtnWWL" class="btn" style="width: 80px">Clear</button>
                        &nbsp;
                        <button id="closeBtnWWL" class="btn" style="width: 80px">Close</button>
                    </div>
                </div>
            </paper-dialog>
        </div>
    </template>
    <script>
        (function () {
            let _this;
            class HhFilmboxWwlpreset extends Polymer.Element {
                static get is() {
                    return 'hh-filmbox-wwlpreset';
                }

                static get properties() {
                    return {
                        curModality:{
                            type:String
                        },
                        preset: {
                            type: Array
                        },
                        title: {
                            type: String
                        },
                        level: {
                            type: String
                        },
                        width: {
                            type: String
                        },
                        modalityList:{
                            type:Array
                        }
                    };
                }

                constructor() {
                    super();
                    _this = this;
                    this.getModality();

                    this.gridOptions = {
                        defaultColDef: {
                            suppressMenu: true // 메뉴 막기
                        },
                        rowDragManaged: true,
                        columnDefs: this.createColumnDefs(),
                        animateRows: true,
                        enableSorting: true,
                        enableColResize: true,
                        rowSelection: "single",
                        overlayNoRowsTemplate: '<span class="ag-overlay-no-rows-center">No records found</span>',
                        toolPanelSuppressSideButtons: true,
                        toolPanelSuppressRowGroups: true,
                        toolPanelSuppressValues: true,
                        toolPanelSuppressColumnSelectAll: true,
                        toolPanelSuppressColumnExpandAll: true,
                        toolPanelSuppressColumnFilter: true,
                        toolPanelSuppressPivots: true,
                        toolPanelSuppressPivotMode: true
                    };

                    // this.columnDefs = [
                    //     {headerName: "idx", field: "idx", width: 60},
                    //     {headerName: "Title", field: "title", width: 90},
                    //     {headerName: "Modality", field: "modality", width: 95},
                    //     {headerName: "Level", field: "level", width: 80},
                    //     {headerName: "Width", field: "width", width: 80},
                    //     {headerName: "Shortcut", field: "key", width: 95},
                    // ];

                    this.gridOptions.onGridReady = (params) => {
                        params.api.sizeColumnsToFit();

                    }

                    this.gridOptions.onRowSelected = (e) => {
                        let g_row_selected = e.node;
                    };

                    // 오른쪽 마우스 : delete
                    this.gridOptions.getContextMenuItems = (params) => {
                        let result = [
                            'separator',
                            {
                                name: 'delete',
                                action: function () {
                                    _this.deletePreset(params.node.data);
                                }
                            },
                            'separator'
                        ];
                        return result;
                    }

                    // 더블클릭 이벤트
                    this.gridOptions.onRowDoubleClicked = (event) => {
                        _this.$.windowDialogWidth.value = event.data.width;
                        _this.$.windowDialogLevel.value = event.data.level;
                        _this.$.windowDialogTitle.value = event.data.title;
                        _this.$.windowDialogIdx.value = event.data.idx;
                        if(event.data.key) {
                            let tempKey = event.data.key;
                            var key = tempKey.split("+");
                            _this.$.key.value = key[1];
                        }
                    }
                }

                ready() {
                    super.ready();
                    this.$.windowDialogLevel.noLabelFloat = true;
                    this.$.windowDialogWidth.noLabelFloat = true;
                    this.$.windowDialogTitle.noLabelFloat = true;
                    this.$.key.noLabelFloat = true;
                    this.$.modality.noLabelFloat = true;

                    this.$.key.addEventListener("value-changed",function (e) {
                        if(!(parseInt(e.detail.value) < 10 && parseInt(e.detail.value) > 0)){
                            e.target.value = "";
                        }
                    });

                    this.$.xBtnWWL.addEventListener("click", function () {
                        _this.doCloseWWL();
                    });

                    this.$.okBtnWWL.addEventListener("click", function () {
                        _this.doOkWWL();
                        _this.doCloseWWL();
                    });

                    this.$.closeBtnWWL.addEventListener("click", function () {
                        _this.doCloseWWL();
                    });

                    this.$.clearBtnWWL.addEventListener("click",function(){
                        _this.doClearWWL();
                    });

                    this.$.WWLDialog.addEventListener("keydown", e => {
                        e.stopPropagation();
                    });
                }// ready

                createColumnDefs() {
                    return [
                        {
                            headerName: "idx",
                            field: "idx",
                            width: 60,
                            rowDrag: true,
                            cellRenderer: function deltaIndicator (param) {
                                const span = param.eGridCell.querySelector("span .ag-row-drag");
                                span.classList.remove('ag-row-drag');
                                span.classList.add('ag-row-drag1');
                                return param.value;
                            },
                            suppressSorting: true
                        },
                        {headerName: "Title", field: "title", width: 90},
                        {headerName: "Modality", field: "modality", width: 95},
                        {headerName: "Level", field: "level", width: 80},
                        {headerName: "Width", field: "width", width: 80},
                        {headerName: "Shortcut", field: "key", width: 95},

                    ];
                }

                setWWLPreset(userWWLPreset) {
                    this.setModality(this.modalityList);
                    this.curModality = window.struct.request.modality[0];
                    this.$.modality.value = this.curModality;

                    if(userWWLPreset && userWWLPreset.length > 0){
                        let row = new Array();
                        for (let i = 0; i < userWWLPreset.length; i++) {
                            let preset = {};
                            preset.idx = i+1;
                            preset.title = userWWLPreset[i].title;
                            preset.modality = userWWLPreset[i].modality;
                            preset.level = userWWLPreset[i].level;
                            preset.width = userWWLPreset[i].width;
                            if(userWWLPreset[i].key) {
                                preset.key = "Alt+" + userWWLPreset[i].key;
                            }
                            row.push(preset);
                        }
                        _this.gridOptions.api.setRowData(row);
                    }else{
                        _this.gridOptions.api.setRowData(null);
                    }

                }

                openDialog(targetElement) {
                    if(targetElement){
                        this.$.WWLDialog.positionTarget = targetElement;
                    }
                    this.$.WWLDialog.open();
                }

                doOkWWL() {
                    let row = new Object();
                    if(this.$.windowDialogTitle.value){
                        if(this.$.windowDialogLevel.value && this.$.windowDialogWidth.value){
                            row.title = this.$.windowDialogTitle.value;
                            row.level = this.$.windowDialogLevel.value;
                            row.width = this.$.windowDialogWidth.value;
                            if(this.$.modality.value && this.$.modality.value.length > 0) {
                                row.modality = this.$.modality.value;
                            }
                            row.keyCode = this.$.key.value.charCodeAt(0);
                            row.key = this.$.key.value;
                            if(this.$.windowDialogIdx.value){
                                row.idx = this.$.windowDialogIdx.value;
                                this.updatePreset(row);
                                this.doClearWWL();
                            }else{
                                this.createPreset(row);
                                this.doClearWWL();
                            }
                        }
                    }
                }

                doCloseWWL() {
                    this.doClearWWL();
                    this.$.WWLDialog.close();
                }

                doClearWWL(){
                    this.$.windowDialogIdx.value = "";
                    this.$.windowDialogTitle.value = "";
                    this.$.windowDialogLevel.value = "";
                    this.$.windowDialogWidth.value = "";
                    this.$.key.value = "";
                    this.$.modality.value = "";
                }

                setLevel(param){
                    // this.getPreset();
                    this.$.windowDialogWidth.value = param.width;
                    this.$.windowDialogLevel.value = param.level;
                }

                createPreset(row){
                    let params = new Object();
                    let detail = new Object();
                    detail.wwlPreset = row;
                    params.detail = detail;
                    this.dispatchEvent(new CustomEvent('createWWLPreset', params));
                }

                updatePreset(row){
                    // console.log("update preset");
                    let params = new Object();
                    let detail = new Object();
                    detail.wwlPreset = row;
                    params.detail = detail;
                    this.dispatchEvent(new CustomEvent('updateWWLPreset', params));
                }

                deletePreset(row){
                    // console.log("delete preset");
                    let params = new Object();
                    let detail = new Object();
                    detail.wwlPreset = row;
                    params.detail = detail;
                    this.dispatchEvent(new CustomEvent('deleteWWLPreset', params));
                }

                getModality(){
                    this.dispatchEvent(new CustomEvent('getModalityWWLPreset'));
                }

                setModality(list) {
                    let modality = list;
                    let sel = this.$.modalityList;
                    if (sel.childElementCount === 0) {
                        for (let i in modality) {
                            let opt = document.createElement('option');
                            opt.innerHTML = modality[i];
                            opt.value = modality[i];
                            sel.appendChild(opt);
                        }
                    }
                }
            }

            window.customElements.define(HhFilmboxWwlpreset.is, HhFilmboxWwlpreset);
        })();
    </script>
</dom-module>
